{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-5">üåê Classic Django Views</h1>
            <p class="text-muted small mb-0">üîí Page Protected by <code style="color: #e61eac;">SessionRequiredMixin</code> class</p>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">‚ö° Function-Based View APIs</h5>
                <p class="card-text">
                    Classic Django function-based views protected with Wristband authentication decorators.
                    These endpoints demonstrate how to secure traditional Django APIs (not using DRF) with two authentication strategies:
                    <strong>session cookies with CSRF protection</strong> for browser-based clients, and <strong>JWT bearer tokens</strong>
                    for stateless API access. Both strategies use Wristband's auth decorators to enforce authentication before executing the view logic.
                </p>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="cookie-tab" role="tab">
                            üç™ Session + CSRF
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="token-tab" role="tab">
                            üîë JWT Bearer Token
                        </a>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content mt-3">
                    <!-- Cookie Authentication Tab -->
                    <div class="tab-pane active" id="cookie-pane">
                        <div class="p-3">
                            <h6>Session Cookie + CSRF Authentication</h6>
                            <p class="text-muted mb-3">
                                Uses the <code>@require_session</code> decorator to validate the session cookie. 
                                Requires CSRF token in the <code>X-CSRFToken</code> header for protection against cross-site request forgery attacks. 
                                Ideal for <strong>AJAX calls from your frontend</strong> to Django backend.
                            </p>
                            <div class="mb-3">
                                <strong>Decorator:</strong> <code>@require_session</code><br>
                                <strong>Endpoint:</strong> <code>POST /api/classic/session-hello</code><br>
                                <strong>Headers:</strong> Session cookie + CSRF token
                            </div>
                            <button id="cookieApiBtn" class="btn btn-primary">Call Cookie API</button>
                            <div id="cookieApiResult" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <pre id="cookieApiResponse"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token Authentication Tab -->
                    <div class="tab-pane" id="token-pane" style="display: none;">
                        <div class="p-3">
                            <h6>JWT Bearer Token Authentication</h6>
                            <p class="text-muted mb-3">
                                Uses the <code>@require_jwt</code> decorator to validate Wristband JWT tokens 
                                from the <code>Authorization: Bearer</code> header. No session or CSRF needed - completely stateless. 
                                Ideal for <strong>mobile apps or external API clients</strong>.
                            </p>
                            <div class="alert alert-warning small mb-3" role="alert">
                                <strong>‚ö†Ô∏è Demo Only:</strong> This example embeds the access token in the template. In production, 
                                fetch tokens from a secure endpoint or store them safely in your app.
                            </div>
                            <div class="mb-3">
                                <strong>Decorator:</strong> <code>@require_jwt</code><br>
                                <strong>Endpoint:</strong> <code>POST /api/classic/jwt-hello</code><br>
                                <strong>Header:</strong> <code>Authorization: Bearer &lt;token&gt;</code>
                            </div>
                            <button id="tokenApiBtn" class="btn btn-success">Call Token API</button>
                            <div id="tokenApiResult" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <pre id="tokenApiResponse"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="{% url 'demo_app:home' %}" class="btn btn-secondary me-2">Back to Home</a>
        </div>
    </div>
</div>

<script>
// Simple tab functionality
document.getElementById('cookie-tab').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Update tab active states
    document.getElementById('cookie-tab').classList.add('active');
    document.getElementById('token-tab').classList.remove('active');
    
    // Show/hide content
    document.getElementById('cookie-pane').style.display = 'block';
    document.getElementById('token-pane').style.display = 'none';
    document.getElementById('cookie-pane').classList.add('active');
    document.getElementById('token-pane').classList.remove('active');
});

document.getElementById('token-tab').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Update tab active states
    document.getElementById('token-tab').classList.add('active');
    document.getElementById('cookie-tab').classList.remove('active');
    
    // Show/hide content
    document.getElementById('token-pane').style.display = 'block';
    document.getElementById('cookie-pane').style.display = 'none';
    document.getElementById('token-pane').classList.add('active');
    document.getElementById('cookie-pane').classList.remove('active');
});

// Session Authentication API Call
document.getElementById('cookieApiBtn').addEventListener('click', async function() {
    const btn = this;
    const resultDiv = document.getElementById('cookieApiResult');
    const responseDiv = document.getElementById('cookieApiResponse');
    
    // Show loading state
    btn.disabled = true;
    btn.textContent = 'Calling API...';
    
    try {
        const response = await fetch('{% url "demo_app:classic_session_hello" %}', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action: 'hello' })
        });

        // Check for 401 or 403 and redirect to login
        if (response.status === 401 || response.status === 403) {
            const loginUrl = new URL('{% url "demo_app:login" %}', window.location.origin);
            loginUrl.searchParams.set('return_url', window.location.href);

            // __WRISTBAND__: Use the current session's tenant name if available at time of redirect.
            const tenantName = '{{ tenant_name|default:"" }}';
            if (tenantName) {
                loginUrl.searchParams.set('tenant_name', tenantName);
            }

            window.location.href = loginUrl.toString();
            return;
        }
        
        const data = await response.json();
        
        // Show result
        responseDiv.textContent = JSON.stringify(data, null, 2);
        resultDiv.style.display = 'block';
        
    } catch (error) {
        responseDiv.textContent = 'Error: ' + error.message;
        resultDiv.style.display = 'block';
    } finally {
        btn.textContent = 'Call Cookie API';
        btn.disabled = false;
    }
});

// JWT Authentication API Call
document.getElementById('tokenApiBtn').addEventListener('click', async function() {
    const btn = this;
    const resultDiv = document.getElementById('tokenApiResult');
    const responseDiv = document.getElementById('tokenApiResponse');
    
    // Show loading state
    btn.disabled = true;
    btn.textContent = 'Calling API...';
    
    try {
        // Get access token from template context
        // ‚ö†Ô∏è DEMO ONLY: In production, don't embed tokens in HTML!
        // Better: fetch from an implemented Token Endpoint or use sessionStorage
        const accessToken = '{{ access_token|default:""|escapejs }}';
        
        if (!accessToken || accessToken === 'None') {
            responseDiv.textContent = 'Error: No access token available. Please ensure you are logged in.';
            resultDiv.style.display = 'block';
            return;
        }
        
        const response = await fetch('{% url "demo_app:classic_jwt_hello" %}', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ action: 'hello' })
        });

        // Check for 401 and redirect to login
        if (response.status === 401) {
            const loginUrl = new URL('{% url "demo_app:login" %}', window.location.origin);
            loginUrl.searchParams.set('return_url', window.location.href);

            const tenantName = '{{ tenant_name|default:"" }}';
            if (tenantName) {
                loginUrl.searchParams.set('tenant_name', tenantName);
            }

            window.location.href = loginUrl.toString();
            return;
        }
        
        const data = await response.json();
        
        // Show result
        responseDiv.textContent = JSON.stringify(data, null, 2);
        resultDiv.style.display = 'block';
        
    } catch (error) {
        responseDiv.textContent = 'Error: ' + error.message;
        resultDiv.style.display = 'block';
    } finally {
        btn.textContent = 'Call Token API';
        btn.disabled = false;
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [key, value] = cookie.trim().split('=');
        if (key === name) return value;
    }
    return '';
}
</script>
{% endblock %}
